@using DasBlog.Web.Models.BlogViewModels;

@model ListCommentsViewModel
@inject IDasBlogSettings dasBlogSettings

@if (dasBlogSettings.SiteConfiguration.EnableComments && Model?.Comments != null)
{
    <hr />

    <!-- Success Alert for comment actions (approve/delete) -->
    <div class="alert alert-success alert-dismissible fade" role="alert" id="commentActionSuccessAlert" style="display:none;">
        <i class="fa-solid fa-circle-check me-2"></i>
        <strong>Success!</strong> <span id="commentActionSuccessMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <h3 class="comment-section-title" id="@DasBlog.Core.Common.Constants.CommentsStartId">Comment Section</h3>

    <div class="post-comments">
        <div class="post-comments-list">
            @if (Model.ShowComments && Model.Comments.Count > 0)
            {
                foreach (var comment in Model.Comments)
                {
                    <partial name="_CommentPartial" model="comment" />
                    <hr />
                }
            }
        </div>
        @if (Model.AllowComments && dasBlogSettings.AreCommentsPermitted(Model.PostDate))
        {
            @if(Model.CurrentComment != null)
            {
            <partial name="_CommentAddPartial" model="Model.CurrentComment" />
            }
            else
            {
            <partial name="_CommentAddPartial" model="new AddCommentViewModel() { TargetEntryId = Model.PostId }" />
            }
        }
        else
        {
            <p>Comments are closed.</p>
        }
    </div>

    <script>
        (function() {
            function showCommentActionAlert() {
                console.log('Checking for comment action success message...');
                // Check for success message in session storage (from approve/delete actions)
                const successMessage = sessionStorage.getItem('commentActionSuccess');
                console.log('Success message from sessionStorage:', successMessage);

                if (successMessage) {
                    const commentActionSuccessAlert = document.getElementById('commentActionSuccessAlert');
                    const commentActionSuccessMessage = document.getElementById('commentActionSuccessMessage');

                    console.log('Alert element:', commentActionSuccessAlert);
                    console.log('Message element:', commentActionSuccessMessage);

                    if (commentActionSuccessAlert && commentActionSuccessMessage) {
                        commentActionSuccessMessage.textContent = successMessage;
                        commentActionSuccessAlert.style.display = 'block';
                        commentActionSuccessAlert.classList.add('show');
                        console.log('Alert displayed successfully');

                        // Scroll to the alert (it's at the top of the comment section)
                        setTimeout(function() {
                            commentActionSuccessAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);

                        // Auto-dismiss after 5 seconds
                        setTimeout(function() {
                            if (typeof bootstrap !== 'undefined') {
                                const alert = bootstrap.Alert.getOrCreateInstance(commentActionSuccessAlert);
                                alert.close();
                                console.log('Alert auto-dismissed');
                            }
                        }, 5000);
                    } else {
                        console.error('Alert elements not found');
                    }

                    // Clear the message from session storage
                    sessionStorage.removeItem('commentActionSuccess');
                    console.log('Session storage cleared');
                } else {
                    console.log('No success message found in sessionStorage');
                }
            }

            // Check if DOM is already loaded
            if (document.readyState === 'loading') {
                console.log('DOM is loading, adding DOMContentLoaded listener');
                document.addEventListener('DOMContentLoaded', showCommentActionAlert);
            } else {
                // DOM is already loaded
                console.log('DOM is already loaded, showing alert immediately');
                showCommentActionAlert();
            }
        })();
    </script>
}
