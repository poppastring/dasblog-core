@using DasBlog.Services;
@using DasBlog.Core.Common;
@using System.Net;
@inject IDasBlogSettings dasBlogSettings
@model List<CommentAdminViewModel>


@{
    ViewBag.Title = "Manage Comments";
    Layout = "../../Themes/dasblog/_Layout.cshtml";
}

<h1>@ViewData["Title"]</h1>

<!-- Success Alert -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert" id="successAlert">
        <i class="fa-solid fa-circle-check me-2"></i>
        <strong>Success!</strong> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Error Alert -->
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert" id="errorAlert">
        <i class="fa-solid fa-circle-exclamation me-2"></i>
        <strong>Error!</strong> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Dynamic Success Alert (for session storage) -->
<div class="alert alert-success alert-dismissible fade" role="alert" id="dynamicSuccessAlert" style="display:none;">
    <i class="fa-solid fa-circle-check me-2"></i>
    <strong>Success!</strong> <span id="dynamicSuccessMessage"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="container">
    <div>
        <comment-page-control view-context="@ViewContext" />
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Comment</th>
                    <th scope="col"></th>
                    <th scope="col">Audit</th>
                </tr>
            </thead>
            <tbody class="dbc-admin-comment-table">
                @foreach (var comment in Model)
                {
                <comment-css comment="@comment">   
                    <td width="10%">
                        <comment-gravatar-image comment="@comment" css="img-thumbnail rounded float-left" />
                    </td>
                    <td width="70%">
                        <blockquote>
                            <div class="mb-0">
                                <comment-user-home-page-link comment="@comment"/> - 
                                <comment-date comment="@comment" css="fw-light text-muted fs-6" date-time-format="MMMM dd, yyyy H:mm" />
                                <span class="fw-light text-muted fs-6">(@comment.AuthorIPAddress)</span>
                                <p class="mb-0 fw-bold"><a href="admin/manage-comments/@comment.BlogPostId">@comment.Title</a></p>
                                <comment-content css="fw-light" comment="@comment" />
                            </div>
                        </blockquote>
                        <figcaption class="blockquote-footer">
                            <a href="javascript:void(0);" onclick="openReplyModal('@comment.BlogPostId', '@Html.Raw(comment.Title?.Replace("'", "\\'"))')">Reply</a>
                        </figcaption>
                    </td>
                    <td width="20%">
                        <comment-approval-link comment="@comment" admin="true"> 
                            <i class="far fa-thumbs-up fa-lg" data-bs-toggle="tooltip" data-bs-placement="top" title="Approve comment"></i>
                        </comment-approval-link>
                        <comment-delete-link comment="@comment" admin="true" data-bs-placement="top" title="Delete comment">
                            <i class="fas fa-trash-alt fa-lg"></i>
                        </comment-delete-link>
                        <comment-mailto-link comment="@comment"  data-bs-placement="top" title="Email">
                            <i class="far fa-envelope fa-lg"></i>
                        </comment-mailto-link>
                    </td>
                </comment-css>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1" aria-labelledby="replyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="replyModalLabel">Reply to Comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Replying to post: <strong id="replyPostTitle"></strong></p>
                <form id="replyForm">
                    <input type="hidden" id="replyTargetEntryId" name="TargetEntryId" />
                    <div class="mb-3">
                        <label for="replyName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="replyName" name="Name" value="@dasBlogSettings.SiteConfiguration.Copyright" readonly />
                    </div>
                    <div class="mb-3">
                        <label for="replyEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="replyEmail" name="Email" value="@dasBlogSettings.SiteConfiguration.Contact" readonly />
                    </div>
                    <div class="mb-3">
                        <label for="replyHomePage" class="form-label">Homepage</label>
                        <input type="url" class="form-control" id="replyHomePage" name="HomePage" value="@dasBlogSettings.SiteConfiguration.Root" readonly />
                    </div>
                    <div class="mb-3">
                        <label for="replyContent" class="form-label">Comment <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="replyContent" name="Content" rows="5" maxlength="500" required></textarea>
                        <div class="form-text"><span id="charCount">0</span>/500 characters</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitReplyButton">Post Reply</button>
            </div>
        </div>
    </div>
</div>

<!-- Reply Confirmation Modal -->
<div class="modal fade" id="confirmReplyModal" tabindex="-1" aria-labelledby="confirmReplyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmReplyModalLabel">Confirm Reply</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to post this reply?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmReplyButton">Post Reply</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let replyFormElement;

        function openReplyModal(postId, postTitle) {
            document.getElementById('replyTargetEntryId').value = postId;
            document.getElementById('replyPostTitle').textContent = postTitle;
            document.getElementById('replyContent').value = '';
            document.getElementById('charCount').textContent = '0';

            const replyModal = new bootstrap.Modal(document.getElementById('replyModal'));
            replyModal.show();
        }

        document.addEventListener('DOMContentLoaded', function() {
            replyFormElement = document.getElementById('replyForm');
            const replyContent = document.getElementById('replyContent');
            const charCount = document.getElementById('charCount');
            const submitReplyButton = document.getElementById('submitReplyButton');
            const confirmReplyButton = document.getElementById('confirmReplyButton');
            const replyModal = document.getElementById('replyModal');
            const confirmReplyModal = document.getElementById('confirmReplyModal');

            // Character counter
            replyContent.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });

            // Submit reply button - show confirmation modal
            submitReplyButton.addEventListener('click', function() {
                const content = replyContent.value.trim();

                if (!content) {
                    alert('Please enter a comment.');
                    return;
                }

                // Close reply modal and show confirmation modal
                const bsReplyModal = bootstrap.Modal.getInstance(replyModal);
                if (bsReplyModal) {
                    bsReplyModal.hide();
                }

                setTimeout(function() {
                    const bsConfirmModal = new bootstrap.Modal(confirmReplyModal);
                    bsConfirmModal.show();
                }, 300);
            });

            // Confirm reply button - submit the form
            confirmReplyButton.addEventListener('click', function() {
                const formData = new FormData(replyFormElement);
                const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]');

                if (antiForgeryToken) {
                    formData.append('__RequestVerificationToken', antiForgeryToken.value);
                }

                fetch('/admin/add-admin-comment', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': antiForgeryToken ? antiForgeryToken.value : ''
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        return response.text();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while posting the comment.');
                });

                // Close confirmation modal
                const bsConfirmModal = bootstrap.Modal.getInstance(confirmReplyModal);
                if (bsConfirmModal) {
                    bsConfirmModal.hide();
                }
            });

            // Check for success message in session storage (from approve/delete actions)
            const successMessage = sessionStorage.getItem('commentActionSuccess');
            if (successMessage) {
                const dynamicSuccessAlert = document.getElementById('dynamicSuccessAlert');
                const dynamicSuccessMessage = document.getElementById('dynamicSuccessMessage');

                if (dynamicSuccessAlert && dynamicSuccessMessage) {
                    dynamicSuccessMessage.textContent = successMessage;
                    dynamicSuccessAlert.style.display = 'block';
                    dynamicSuccessAlert.classList.add('show');

                    window.scrollTo({ top: 0, behavior: 'smooth' });

                    setTimeout(function() {
                        const alert = bootstrap.Alert.getOrCreateInstance(dynamicSuccessAlert);
                        alert.close();
                    }, 5000);
                }

                sessionStorage.removeItem('commentActionSuccess');
            }

            // Auto-dismiss TempData alerts after 5 seconds
            const successAlert = document.getElementById('successAlert');
            if (successAlert) {
                window.scrollTo({ top: 0, behavior: 'smooth' });

                setTimeout(function() {
                    const alert = bootstrap.Alert.getOrCreateInstance(successAlert);
                    alert.close();
                }, 5000);
            }

            const errorAlert = document.getElementById('errorAlert');
            if (errorAlert) {
                window.scrollTo({ top: 0, behavior: 'smooth' });

                setTimeout(function() {
                    const alert = bootstrap.Alert.getOrCreateInstance(errorAlert);
                    alert.close();
                }, 5000);
            }
        });
    </script>

    @Html.AntiForgeryToken()
}
