@using DasBlog.Web.Models.AdminViewModels

@inject IDasBlogSettings dasBlogSettings
@model DasBlogSettingsViewModel

@{
    ViewBag.Title = "Site Settings";
    Layout = "../../Themes/dasblog/_Layout.cshtml";
}

<h1>@ViewData["Title"]</h1>
<hr />
@Html.ValidationSummary(false, "", new { @class = "text-danger" })

<!-- Success Alert -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert" id="successAlert">
        <i class="fa-solid fa-circle-check me-2"></i>
        <strong>Success!</strong> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form asp-action="settings" method="post" name="UpdateSettingsForm" id="UpdateSettingsForm">

    <div class="accordion" id="accordionExample">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    Main
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_General" />
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFrontPage" aria-expanded="false" aria-controls="collapseFrontPage">
                    Front Page
                </button>
            </h2>
            <div id="collapseFrontPage" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_FrontPage" />
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRSSFeed" aria-expanded="false" aria-controls="collapseRSSFeed">
                    RSS Feed
                </button>
            </h2>
            <div id="collapseRSSFeed" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_RSSFeed" />
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseComments" aria-expanded="false" aria-controls="collapseComments">
                    Comments
                </button>
            </h2>
            <div id="collapseComments" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_Comments" />
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMetaData" aria-expanded="false" aria-controls="collapseMetaData">
                    Meta data
                </button>
            </h2>
            <div id="collapseMetaData" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_MetaData" />
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSocial" aria-expanded="false" aria-controls="collapseSocial">
                    Social
                </button>
            </h2>
            <div id="collapseSocial" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_Social" />
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBloggingEditing" aria-expanded="false" aria-controls="collapseBloggingEditing">
                    Blogging & Editing
                </button>
            </h2>
            <div id="collapseBloggingEditing" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_BlogEditing" />
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmailNotifications" aria-expanded="false" aria-controls="collapseEmailNotifications">
                    Email & Notifications
                </button>
            </h2>
            <div id="collapseEmailNotifications" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_EmailNotifications" />
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAppearance" aria-expanded="false" aria-controls="collapseAppearance">
                    Appearance
                </button>
            </h2>
            <div id="collapseAppearance" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_Appearance" />
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInternal" aria-expanded="false" aria-controls="collapseInternal">
                    Internal
                </button>
            </h2>
            <div id="collapseInternal" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_Internal" />
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSecurity" aria-expanded="false" aria-controls="collapseSecurity">
                    Security
                </button>
            </h2>
            <div id="collapseSecurity" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <partial name="_Admin_Security" />
                </div>
            </div>
        </div>
    </div>

    <hr />

    <div class="d-flex flex-wrap">
        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#confirmSaveModal">Save</button>
        <input asp-controller="Home" asp-action="Index" type="submit" name="submit" value="Cancel" class="btn btn-secondary me-2" />
    </div>

    <!-- Hidden submit button for actual form submission -->
    <input type="submit" name="submitAction" value="Save" id="hiddenSaveButton" style="display:none;" />

    <!-- Save Confirmation Modal -->
    <div class="modal fade" id="confirmSaveModal" tabindex="-1" aria-labelledby="confirmSaveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmSaveModalLabel">Confirm Save</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to save the site settings?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmSaveButton">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {

        <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-2.2.0.min.js"></script>
        <script src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.16.0/jquery.validate.min.js"></script>
        <script src="https://ajax.aspnetcdn.com/ajax/jquery.validation.unobtrusive/3.2.6/jquery.validate.unobtrusive.min.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const confirmSaveButton = document.getElementById('confirmSaveButton');
                const hiddenSaveButton = document.getElementById('hiddenSaveButton');
                const confirmSaveModal = document.getElementById('confirmSaveModal');

                // Restore accordion state from localStorage
                restoreAccordionState();

                // Track accordion state changes
                const accordionItems = document.querySelectorAll('.accordion-collapse');
                accordionItems.forEach(function(item) {
                    item.addEventListener('shown.bs.collapse', function() {
                        saveAccordionState();
                    });
                    item.addEventListener('hidden.bs.collapse', function() {
                        saveAccordionState();
                    });
                });

                confirmSaveButton.addEventListener('click', function() {
                    // Save current accordion state before form submission
                    saveAccordionState();

                    // Close the modal
                    const modalInstance = bootstrap.Modal.getInstance(confirmSaveModal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }

                    // Click the hidden submit button to trigger normal form submission
                    setTimeout(function() {
                        hiddenSaveButton.click();
                    }, 300);
                });

                // Auto-dismiss success alert after 5 seconds
                const successAlert = document.getElementById('successAlert');
                if (successAlert) {
                    // Scroll to top to show the alert
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                    setTimeout(function() {
                        const alert = bootstrap.Alert.getOrCreateInstance(successAlert);
                        alert.close();
                    }, 5000);
                }

                // Functions to save and restore accordion state
                function saveAccordionState() {
                    const openAccordions = [];
                    accordionItems.forEach(function(item) {
                        if (item.classList.contains('show')) {
                            openAccordions.push(item.id);
                        }
                    });
                    localStorage.setItem('settingsAccordionState', JSON.stringify(openAccordions));
                }

                function restoreAccordionState() {
                    const savedState = localStorage.getItem('settingsAccordionState');
                    if (savedState) {
                        try {
                            const openAccordions = JSON.parse(savedState);
                            openAccordions.forEach(function(accordionId) {
                                const accordionElement = document.getElementById(accordionId);
                                if (accordionElement) {
                                    const bsCollapse = new bootstrap.Collapse(accordionElement, {
                                        show: true
                                    });
                                }
                            });
                        } catch (e) {
                            console.error('Error restoring accordion state:', e);
                        }
                    }
                }
            });
        </script>

    }


    @Html.HiddenFor(@m => m.SiteConfig.EnableTitlePermaLinkSpaces)
    @Html.HiddenFor(@m => m.SiteConfig.CategoryAllEntries)

    @Html.HiddenFor(@m => m.SiteConfig.EntryTitleAsLink)
    @Html.HiddenFor(@m => m.SiteConfig.ObfuscateEmail)

    @Html.HiddenFor(@m => m.SiteConfig.CommentsAllowHtml)
    @Html.HiddenFor(@m => m.SiteConfig.SendReferralsByEmail)
    @Html.HiddenFor(@m => m.SiteConfig.SendTrackbacksByEmail)
    @Html.HiddenFor(@m => m.SiteConfig.SendPingbacksByEmail)
    @Html.HiddenFor(@m => m.SiteConfig.SendPostsByEmail)
    @Html.HiddenFor(@m => m.SiteConfig.EnableCommentApi)
    @Html.HiddenFor(@m => m.SiteConfig.EnableConfigEditService)
    @Html.HiddenFor(@m => m.SiteConfig.EnableEditService)
    @Html.HiddenFor(@m => m.SiteConfig.EnableAutoPingback)
    @Html.HiddenFor(@m => m.SiteConfig.EnableTrackbackService)
    @Html.HiddenFor(@m => m.SiteConfig.EnablePingbackService)

    @Html.HiddenFor(@m => m.SiteConfig.EnableBlogrollDescription)
    @Html.HiddenFor(@m => m.SiteConfig.EnableUrlRewriting)
    @Html.HiddenFor(@m => m.SiteConfig.EnableCrossposts)

    @Html.HiddenFor(@m => m.SiteConfig.UseUserCulture)
    @Html.HiddenFor(@m => m.SiteConfig.ExtensionlessUrls)
    @Html.HiddenFor(@m => m.SiteConfig.EnableAggregatorBugging)

    @Html.HiddenFor(@m => m.SiteConfig.EnableClickThrough)

    @Html.HiddenFor(@m => m.SiteConfig.EnablePop3)
    @Html.HiddenFor(@m => m.SiteConfig.Pop3InlineAttachedPictures)
    @Html.HiddenFor(@m => m.SiteConfig.Pop3InlinedAttachedPicturesThumbHeight)

    @Html.HiddenFor(@m => m.SiteConfig.ApplyContentFiltersToWeb)
    @Html.HiddenFor(@m => m.SiteConfig.ApplyContentFiltersToRSS)
    @Html.HiddenFor(@m => m.SiteConfig.EnableXSSUpstream)

    @Html.HiddenFor(@m => m.SiteConfig.XSSUpstreamEndpoint)
    @Html.HiddenFor(@m => m.SiteConfig.XSSUpstreamUsername)
    @Html.HiddenFor(@m => m.SiteConfig.XSSUpstreamPassword)

    @Html.HiddenFor(@m => m.SiteConfig.XSSRSSFilename)
    @Html.HiddenFor(@m => m.SiteConfig.XSSUpstreamInterval)

    @Html.HiddenFor(@m => m.SiteConfig.Pop3DeleteAllMessages)
    @Html.HiddenFor(@m => m.SiteConfig.Pop3LogIgnoredEmails)
    @Html.HiddenFor(@m => m.SiteConfig.EnableReferralUrlBlackList)

    @Html.HiddenFor(@m => m.SiteConfig.ReferralUrlBlackList)
    @Html.HiddenFor(@m => m.SiteConfig.EnableReferralUrlBlackList404s)

    @Html.HiddenFor(@m => m.SiteConfig.EnableMovableTypeBlackList)
    @Html.HiddenFor(@m => m.SiteConfig.EnableCrossPostFooter)
    @Html.HiddenFor(@m => m.SiteConfig.EncryptLoginPassword)

    @Html.HiddenFor(@m => m.SiteConfig.RssLanguage)
    @Html.HiddenFor(@m => m.SiteConfig.EnableSearchHighlight)

    @Html.HiddenFor(@m => m.SiteConfig.EnableEntryReferrals)
    @Html.HiddenFor(@m => m.SiteConfig.FeedBurnerName)
    @Html.HiddenFor(@m => m.SiteConfig.SupressEmailAddressDisplay)

    @Html.HiddenFor(@m => m.SiteConfig.LogBlockedReferrals)
    @Html.HiddenFor(@m => m.SiteConfig.UseFeedSchemeForSyndication)
    @Html.HiddenFor(@m => m.SiteConfig.EnableAutoSave)

    @Html.HiddenFor(@m => m.SiteConfig.CommentsAllowGravatar)
    @Html.HiddenFor(@m => m.SiteConfig.CommentsGravatarNoImgPath)
    @Html.HiddenFor(@m => m.SiteConfig.CommentsGravatarSize)

    @Html.HiddenFor(@m => m.SiteConfig.CommentsGravatarBorder)
    @Html.HiddenFor(@m => m.SiteConfig.CommentsGravatarRating)
    @Html.HiddenFor(@m => m.SiteConfig.EnableCoComment)

    @Html.HiddenFor(@m => m.SiteConfig.EnableSpamBlockingService)
    @Html.HiddenFor(@m => m.SiteConfig.SpamBlockingServiceApiKey)
    @Html.HiddenFor(@m => m.SiteConfig.EnableSpamModeration)

    @Html.HiddenFor(@m => m.SiteConfig.EnableDailyReportEmail)

    @Html.HiddenFor(@m => m.SiteConfig.EnableGoogleMaps)
    @Html.HiddenFor(@m => m.SiteConfig.GoogleMapsApiKey)

    @Html.HiddenFor(@m => m.SiteConfig.EnableGeoRss)
    @Html.HiddenFor(@m => m.SiteConfig.DefaultLatitude)
    @Html.HiddenFor(@m => m.SiteConfig.DefaultLongitude)

    @Html.HiddenFor(@m => m.SiteConfig.EnableDefaultLatLongForNonGeoCodedPosts)
    @Html.HiddenFor(@m => m.SiteConfig.HtmlTidyContent)
    @Html.HiddenFor(@m => m.SiteConfig.ResolveCommenterIP)

    @Html.HiddenFor(@m => m.SiteConfig.AllowOpenIdComments)
    @Html.HiddenFor(@m => m.SiteConfig.AllowOpenIdAdmin)
    @Html.HiddenFor(@m => m.SiteConfig.BypassSpamOpenIdComment)

    @Html.HiddenFor(@m => m.SiteConfig.AMPPagesEnabled)
    @Html.HiddenFor(@m => m.SiteConfig.RSSEndPointRewrite)


    @Html.HiddenFor(@m => m.MetaConfig.FaceBookAdmins)
    @Html.HiddenFor(@m => m.MetaConfig.FaceBookAppID)

</form>
